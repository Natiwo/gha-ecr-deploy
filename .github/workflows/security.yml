# Security Scan - Scheduled and on-demand
name: Security

on:
  schedule:
    - cron: '0 6 * * *'  # Daily 6h UTC
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - secrets
          - vulnerabilities
          - iac

jobs:
  secrets:
    name: Secret Scan
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'all' || inputs.scan_type == 'secrets' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Trivy secret scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'
          format: 'table'

      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  vulnerabilities:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'all' || inputs.scan_type == 'vulnerabilities' || github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        target: [minimal, runtime]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: ${{ matrix.target }}
          load: true
          tags: scan-${{ matrix.target }}:latest

      - name: Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: scan-${{ matrix.target }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Grype scan
        uses: anchore/scan-action@v4
        with:
          image: scan-${{ matrix.target }}:latest
          fail-build: false
          severity-cutoff: high

  iac:
    name: IaC Scan
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'all' || inputs.scan_type == 'iac' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Checkov scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile,github_actions
          soft_fail: true

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    strategy:
      matrix:
        target: [minimal, runtime]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: ${{ matrix.target }}
          load: true
          tags: sbom-${{ matrix.target }}:latest

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: sbom-${{ matrix.target }}:latest
          artifact-name: sbom-${{ matrix.target }}.spdx.json
          format: spdx-json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.target }}
          path: sbom-${{ matrix.target }}.spdx.json
          retention-days: 90

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [secrets, vulnerabilities, iac]
    if: always()
    steps:
      - name: Report
        run: |
          echo "## Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets | ${{ needs.secrets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerabilities | ${{ needs.vulnerabilities.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC | ${{ needs.iac.result }} |" >> $GITHUB_STEP_SUMMARY
